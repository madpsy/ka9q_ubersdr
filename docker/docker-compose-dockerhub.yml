services:
  # ka9q-radio backend (radiod) - SDR receiver daemon
  ka9q-radio:
    image: madpsy/ka9q-radio:latest
    container_name: ka9q-radio
    privileged: true
    restart: unless-stopped

    # Use external bridge network for multicast communication
    networks:
      - sdr-network

    volumes:
      # Mount USB devices for SDR hardware access
      - /dev/bus/usb:/dev/bus/usb
      # Persistent configuration - initialized from templates on first run
      # Edit configs in the volume, they will persist across container restarts
      # To reset to defaults, delete the volume: docker volume rm docker_radiod-config
      - radiod-config:/etc/ka9q-radio
      # Persistent data directory for recordings and wisdom
      - radiod-data:/var/lib/ka9q-radio
      # Optional: Mount custom configuration from host (overrides persistent volume)
      # - ../../ka9q-radio/docker/radiod@ubersdr.conf:/etc/ka9q-radio/radiod@ubersdr.conf
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger

    environment:
      - TZ=${TZ:-UTC}

    # Optional: Override the default command to use a different config
    # command: ["/usr/local/sbin/radiod", "/etc/ka9q-radio/radiod@custom.conf"]

    # Healthcheck
    healthcheck:
      test: [CMD, pgrep, -x, radiod]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "ka9q-radio"

  # ka9q_ubersdr service - Web interface
  ubersdr:
    image: madpsy/ka9q_ubersdr:latest
    container_name: ka9q_ubersdr
    restart: unless-stopped
    init: true  # Enable tini init to reap zombie processes from background watchers

    # Wait for ka9q-radio to be healthy before starting
    depends_on:
      ka9q-radio:
        condition: service_healthy

    # Use external bridge network for multicast communication with radiod
    networks:
      - sdr-network

    # Expose web interface ports
    ports:
      - 8080:8080   # Main UberSDR web interface
      - 8073:8073   # KiwiSDR protocol compatibility (if enabled in config)

    # Environment variables
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      - TZ=${TZ:-UTC}
      - DEBUG=true

    # Volumes for persistent configuration only (static files are part of the image)
    volumes:
      - ubersdr-config:/app/config
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger
      # Shared radiod config for read/write access (allows ubersdr to modify radiod config)
      - radiod-config:/etc/ka9q-radio
      # Shared volume for Caddy configuration
      - caddy-shared:/etc/caddy-shared
      # Shared volume for tunnel client configuration
      - tunnel-client-config:/app/tunnel-client-config
      # Version updater directory (accessible from host)
      - ./updater:/var/run/updater

    # Healthcheck
    healthcheck:
      test: [CMD, wget, --no-verbose, --tries=1, --spider, http://localhost:8080/]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "ubersdr"

    # Resource limits (optional)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

  # Caddy reverse proxy for HTTPS access
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    init: true  # Enable tini init to reap zombie processes (fixes defunct ssl_client)

    # Wait for ubersdr to be healthy before starting
    depends_on:
      ubersdr:
        condition: service_healthy

    networks:
      - sdr-network

    # Expose HTTP and HTTPS ports
    ports:
      - 80:80
      - 443:443
      - 443:443/udp  # HTTP/3

    volumes:
      # Shared volume for dynamic Caddyfile (generated by ubersdr)
      - caddy-shared:/etc/caddy-shared
      # Persistent data for certificates
      - caddy-data:/data
      - caddy-config:/config
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger
      # Mount custom entrypoint script for restart watching
      - ./caddy-entrypoint.sh:/usr/local/bin/caddy-entrypoint.sh:ro

    environment:
      - TZ=${TZ:-UTC}

    # Use custom entrypoint that watches for restart trigger
    entrypoint: ["/usr/local/bin/caddy-entrypoint.sh"]
    # Use Caddyfile from shared volume (generated by ubersdr on startup)
    command: ["caddy", "run", "--config", "/etc/caddy-shared/Caddyfile", "--adapter", "caddyfile"]

    # Healthcheck
    healthcheck:
      test: [CMD, wget, --no-verbose, --tries=1, --spider, http://localhost:80/]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "caddy"

  # Tunnel client - Connects local UberSDR to public tunnel server
  tunnel-client:
    image: madpsy/tunnel-client:latest
    container_name: tunnel-client
    restart: unless-stopped

    # Wait for ubersdr to be healthy before starting
    depends_on:
      ubersdr:
        condition: service_healthy

    networks:
      - sdr-network

    volumes:
      # Persistent configuration
      - tunnel-client-config:/app/config
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger

    environment:
      - TZ=${TZ:-UTC}

    # Healthcheck - verify tunnel connection is active and healthy
    healthcheck:
      test: [CMD, wget, --no-verbose, --tries=1, --spider, http://localhost:8081/health]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "tunnel-client"

  # Fluent Bit log collector - sends container logs to central collector
  fluent-bit:
    image: madpsy/fluent-bit-ubersdr:latest
    container_name: fluent-bit
    restart: unless-stopped

    # DO NOT wait for ubersdr to be healthy before starting
    #depends_on:
    #  ubersdr:
    #    condition: service_healthy

    networks:
      - sdr-network

    ports:
      - "127.0.0.1:24224:24224"

    volumes:
      # Access to UberSDR config to read instance UUID and collector settings
      - ubersdr-config:/app/config:ro

    environment:
      - TZ=${TZ:-UTC}

    # Healthcheck
    healthcheck:
      test: [CMD, pgrep, -x, fluent-bit]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # GoTTY terminal access - Web-based SSH terminal
  ubersdr-gotty:
    image: madpsy/ubersdr-gotty:latest
    container_name: ubersdr-gotty
    restart: unless-stopped

    networks:
      - sdr-network

    # No ports exposed - accessed only via ubersdr reverse proxy

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      - ${HOME}/.ssh/ubersdr_gotty_key:/root/.ssh/id_rsa:ro
      - ${HOME}/.ssh/ubersdr_gotty_key.pub:/root/.ssh/id_rsa.pub:ro

    environment:
      - USER=${USER}
      - REMOTE_HOST=${HOSTNAME}
      - TZ=${TZ:-UTC}

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "ubersdr-gotty"

  # Multicast relay with Avahi mDNS bridge - Exposes multicast to host network
  multicast-relay:
    image: madpsy/ubersdr-multicast:latest
    container_name: multicast-relay
    restart: unless-stopped

    # REQUIRED: Host network mode for mDNS bridging and multicast routing
    network_mode: host

    # REQUIRED: NET_ADMIN capability for multicast routing
    cap_add:
      - NET_ADMIN

    # Wait for ka9q-radio to be healthy before starting
    depends_on:
      ka9q-radio:
        condition: service_healthy

    volumes:
      # Read-only access to UberSDR config to discover multicast groups
      - ubersdr-config:/config:ro
      # Shared volume for restart trigger coordination
      - restart-trigger:/var/run/restart-trigger
      # Docker socket for network discovery (read-only)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Host's D-Bus socket for Avahi mDNS publishing
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket

    environment:
      # Config file path - container reads all settings from config.yaml
      - CONFIG_FILE=/config/config.yaml
      # Timezone
      - TZ=${TZ:-UTC}

    # Healthcheck - verify smcroute is running
    healthcheck:
      test: [CMD, pgrep, -x, smcroute]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "fluentd"
      options:
        fluentd-address: "127.0.0.1:24224"
        fluentd-async: "true"
        tag: "multicast-relay"

# Shared network between ka9q-radio and ubersdr containers
# Docker Compose will create this automatically with the specified subnet
networks:
  sdr-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  radiod-config:
  radiod-data:
  ubersdr-config:
  restart-trigger:
  caddy-data:
  caddy-config:
  caddy-shared:
  tunnel-client-config:
  # Note: updater directory is bind-mounted from host (./updater)
services:
  # ka9q-radio backend (radiod) - SDR receiver daemon
  ka9q-radio:
    build:
      context: ../../ka9q-radio
      dockerfile: docker/Dockerfile
    image: ka9q-radio:latest
    container_name: ka9q-radio
    privileged: true
    restart: unless-stopped

    # Use external bridge network for multicast communication
    networks:
      - sdr-network

    volumes:
      # Mount USB devices for SDR hardware access
      - /dev/bus/usb:/dev/bus/usb
      # Persistent configuration - initialized from templates on first run
      # Edit configs in the volume, they will persist across container restarts
      # To reset to defaults, delete the volume: docker volume rm docker_radiod-config
      - radiod-config:/etc/ka9q-radio
      # Persistent data directory for recordings and wisdom
      - radiod-data:/var/lib/ka9q-radio
      # Optional: Mount custom configuration from host (overrides persistent volume)
      # - ../../ka9q-radio/docker/radiod@ubersdr.conf:/etc/ka9q-radio/radiod@ubersdr.conf
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger

    environment:
      - TZ=${TZ:-UTC}

    # Optional: Override the default command to use a different config
    # command: ["/usr/local/sbin/radiod", "/etc/ka9q-radio/radiod@custom.conf"]

    # Healthcheck
    healthcheck:
      test: [CMD, pgrep, -x, radiod]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ka9q_ubersdr service - Web interface
  ubersdr:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: ka9q_ubersdr:latest
    container_name: ka9q_ubersdr
    restart: unless-stopped
    shm_size: '512m'

    # Wait for ka9q-radio to be healthy before starting
    depends_on:
      ka9q-radio:
        condition: service_healthy

    # Use external bridge network for multicast communication with radiod
    networks:
      - sdr-network

    # Expose web interface ports
    ports:
      - 8080:8080   # Main UberSDR web interface
      - 8073:8073   # KiwiSDR protocol compatibility (if enabled in config)

    # Environment variables
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      - TZ=${TZ:-UTC}
      - DEBUG=true

    # Volumes for persistent configuration only (static files are part of the image)
    volumes:
      - ubersdr-config:/app/config
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger
      # Shared radiod config for read/write access (allows ubersdr to modify radiod config)
      - radiod-config:/etc/ka9q-radio
      # Shared volume for Caddy configuration
      - caddy-shared:/etc/caddy-shared
      # Version updater directory (accessible from host)
      - ./updater:/var/run/updater

    # Healthcheck
    healthcheck:
      test: [CMD, wget, --no-verbose, --tries=1, --spider, http://localhost:8080/]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Resource limits (optional)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

  # Caddy reverse proxy for HTTPS access
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped

    # Wait for ubersdr to be healthy before starting
    depends_on:
      ubersdr:
        condition: service_healthy

    networks:
      - sdr-network

    # Expose HTTP and HTTPS ports
    ports:
      - 80:80
      - 443:443
      - 443:443/udp  # HTTP/3

    volumes:
      # Shared volume for dynamic Caddyfile (generated by ubersdr)
      - caddy-shared:/etc/caddy-shared
      # Persistent data for certificates
      - caddy-data:/data
      - caddy-config:/config
      # Shared volume for restart trigger
      - restart-trigger:/var/run/restart-trigger
      # Mount custom entrypoint script for restart watching
      - ./caddy-entrypoint.sh:/usr/local/bin/caddy-entrypoint.sh:ro

    environment:
      - TZ=${TZ:-UTC}

    # Use custom entrypoint that watches for restart trigger
    entrypoint: ["/usr/local/bin/caddy-entrypoint.sh"]
    # Use Caddyfile from shared volume (generated by ubersdr on startup)
    command: ["caddy", "run", "--config", "/etc/caddy-shared/Caddyfile", "--adapter", "caddyfile"]

    # Healthcheck
    healthcheck:
      test: [CMD, wget, --no-verbose, --tries=1, --spider, http://localhost:80/]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Fluent Bit log collector - sends container logs to central collector
  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    restart: unless-stopped

    # Wait for ubersdr to be healthy before starting (ensures UUID is generated)
    depends_on:
      ubersdr:
        condition: service_healthy

    networks:
      - sdr-network

    volumes:
      # Fluent Bit configuration
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      # Custom entrypoint script to read config and set environment variables
      - ./fluent-bit-entrypoint.sh:/fluent-bit-entrypoint.sh:ro
      # Access to UberSDR config to read instance UUID and collector settings
      - ubersdr-config:/app/config:ro
      # Access to Docker container logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Persistent database for tracking log positions
      - fluent-bit-data:/var/log

    environment:
      - TZ=${TZ:-UTC}

    # Use custom entrypoint that reads config and starts Fluent Bit
    entrypoint: ["/fluent-bit-entrypoint.sh"]

    # Healthcheck
    healthcheck:
      test: [CMD, pgrep, -x, fluent-bit]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Shared network between ka9q-radio and ubersdr containers
# Docker Compose will create this automatically with the specified subnet
networks:
  sdr-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  radiod-config:
  radiod-data:
  ubersdr-config:
  restart-trigger:
  caddy-data:
  caddy-config:
  caddy-shared:
  fluent-bit-data:
  # Note: updater directory is bind-mounted from host (./updater)
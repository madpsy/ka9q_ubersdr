<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UberSDR Chat - Simple Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        #chat-messages {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
        }
        .message .username {
            font-weight: bold;
            color: #0066cc;
            cursor: pointer;
        }
        .message .username:hover {
            text-decoration: underline;
        }
        .system-message {
            color: #666;
            font-style: italic;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
        }
        .muted {
            opacity: 0.5;
            text-decoration: line-through;
        }
        input, button {
            padding: 8px;
            margin: 5px;
        }
        #message-input {
            width: 60%;
        }
        .info-panel {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>UberSDR Live Chat - Simple Example</h1>
    
    <div class="info-panel">
        <strong>Status:</strong> <span id="status">Disconnected</span><br>
        <strong>Your Username:</strong> <span id="current-username">Not set</span><br>
        <strong>Your Frequency:</strong> <span id="current-frequency">Not set</span><br>
        <strong>Your Mode:</strong> <span id="current-mode">Not set</span>
    </div>

    <div id="setup-panel">
        <h3>Join Chat</h3>
        <input type="text" id="username-input" placeholder="Username (alphanumeric, max 15)" maxlength="15">
        <button id="join-btn">Join</button>
    </div>

    <div id="chat-panel" style="display:none;">
        <h3>Chat Messages</h3>
        <div id="chat-messages"></div>
        
        <input type="text" id="message-input" placeholder="Type message (max 250 chars)" maxlength="250">
        <button id="send-btn">Send</button>
        <button id="leave-btn" style="background-color: #dc3545;">Leave</button>
        
        <h3>Set Frequency & Mode (Optional)</h3>
        <input type="number" id="freq-input" placeholder="Frequency (Hz)" min="0" max="30000000" step="1000">
        <select id="mode-select">
            <option value="">Select mode...</option>
            <option value="usb">USB</option>
            <option value="lsb">LSB</option>
            <option value="am">AM</option>
            <option value="fm">FM</option>
            <option value="cwu">CWU</option>
            <option value="cwl">CWL</option>
            <option value="sam">SAM</option>
            <option value="nfm">NFM</option>
        </select>
        <input type="number" id="bw-high-input" placeholder="BW High (Hz)" min="-10000" max="10000" value="0">
        <input type="number" id="bw-low-input" placeholder="BW Low (Hz)" min="-10000" max="10000" value="0">
        <button id="set-freq-btn">Set Frequency/Mode</button>
        
        <div class="info-panel">
            <strong>Active Users:</strong> <span id="user-count">0</span>
            <div id="user-list"></div>
        </div>
    </div>

    <!-- Include the chat library -->
    <script src="chat.js"></script>
    
    <script>
        let ws = null;
        let chat = null;
        let userSessionId = generateUUID();

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Register session with server
        async function registerSession() {
            try {
                const response = await fetch('/connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_session_id: userSessionId })
                });
                return response.ok;
            } catch (error) {
                console.error('Failed to register session:', error);
                return false;
            }
        }

        // Connect to WebSocket
        async function connect() {
            // Register session first
            if (!await registerSession()) {
                addSystemMessage('Failed to register session');
                setTimeout(connect, 5000);
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dxcluster?user_session_id=${userSessionId}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').style.color = 'green';
                
                // Initialize chat system
                chat = new UberSDRChat(ws);
                setupChatHandlers();
            };

            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').style.color = 'red';
                chat = null;
                setTimeout(connect, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Set up chat event handlers
        function setupChatHandlers() {
            chat.on('message', (data) => {
                addChatMessage(data.username, data.message, data.timestamp);
            });

            chat.on('join_confirmed', (data) => {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('chat-panel').style.display = 'block';
                document.getElementById('current-username').textContent = data.username;
                addSystemMessage(`You joined as ${data.username}`);
                chat.requestActiveUsers();
            });

            chat.on('user_joined', (data) => {
                addSystemMessage(`${data.username} joined the chat`);
                chat.requestActiveUsers();
            });

            chat.on('user_left', (data) => {
                addSystemMessage(`${data.username} left the chat`);
                chat.requestActiveUsers();
            });

            chat.on('active_users', (data) => {
                updateActiveUsers(data);
            });

            chat.on('error', (error) => {
                addErrorMessage(error);
            });

            chat.on('user_muted', (username) => {
                addSystemMessage(`Muted ${username}`);
            });

            chat.on('user_unmuted', (username) => {
                addSystemMessage(`Unmuted ${username}`);
            });
        }

        // Add chat message to display
        function addChatMessage(username, message, timestamp) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message';
            
            const time = new Date(timestamp).toLocaleTimeString();
            div.innerHTML = `
                <span class="username" onclick="toggleMute('${escapeHtml(username)}')">${escapeHtml(username)}:</span>
                <span>${escapeHtml(message)}</span>
                <span style="color:#999; font-size:0.9em;">(${time})</span>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Add system message
        function addSystemMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message system-message';
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Add error message
        function addErrorMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message error-message';
            div.textContent = 'Error: ' + text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Update active users list
        function updateActiveUsers(data) {
            document.getElementById('user-count').textContent = data.count;
            const userList = document.getElementById('user-list');
            
            const userItems = data.users.map(u => {
                let info = escapeHtml(u.username);
                if (u.frequency && u.mode) {
                    const freqMHz = (u.frequency / 1000000).toFixed(3);
                    info += ` (${freqMHz} MHz, ${u.mode.toUpperCase()})`;
                }
                if (chat && chat.isMuted(u.username)) {
                    info = `<span class="muted">${info}</span>`;
                }
                return info;
            });
            
            userList.innerHTML = userItems.join('<br>');
        }

        // Toggle mute for a user
        function toggleMute(username) {
            if (chat) {
                chat.toggleMute(username);
                chat.requestActiveUsers(); // Refresh display
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event handlers
        document.getElementById('join-btn').addEventListener('click', () => {
            const username = document.getElementById('username-input').value.trim();
            if (chat) {
                chat.setUsername(username);
            }
        });

        document.getElementById('send-btn').addEventListener('click', () => {
            const message = document.getElementById('message-input').value.trim();
            if (chat && chat.sendMessage(message)) {
                document.getElementById('message-input').value = '';
            }
        });

        document.getElementById('leave-btn').addEventListener('click', () => {
            if (chat) {
                chat.leave();
                document.getElementById('setup-panel').style.display = 'block';
                document.getElementById('chat-panel').style.display = 'none';
                document.getElementById('current-username').textContent = 'Not set';
                document.getElementById('current-frequency').textContent = 'Not set';
                document.getElementById('current-mode').textContent = 'Not set';
                addSystemMessage('You left the chat');
            }
        });

        document.getElementById('set-freq-btn').addEventListener('click', () => {
            const freq = parseInt(document.getElementById('freq-input').value);
            const mode = document.getElementById('mode-select').value;
            const bwHigh = parseInt(document.getElementById('bw-high-input').value) || 0;
            const bwLow = parseInt(document.getElementById('bw-low-input').value) || 0;
            
            if (chat && freq && mode) {
                if (chat.setFrequencyAndMode(freq, mode, bwHigh, bwLow)) {
                    document.getElementById('current-frequency').textContent = (freq / 1000000).toFixed(3) + ' MHz';
                    document.getElementById('current-mode').textContent = mode.toUpperCase();
                    addSystemMessage(`Set frequency to ${(freq/1000000).toFixed(3)} MHz, mode ${mode.toUpperCase()}`);
                }
            }
        });

        // Enter key handlers
        document.getElementById('username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('join-btn').click();
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('send-btn').click();
        });

        // Connect on page load
        connect();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ka9q UberSDR - Web SDR Receiver</title>
    <link rel="stylesheet" href="style.css">
    <!-- Opus decoder for handling Opus-compressed audio -->
    <script src="https://unpkg.com/@wasm-audio-decoders/opus@0.1.12/dist/opus-decoder.min.js"></script>
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FFT and NR2 libraries for noise reduction -->
    <script src="fft.js"></script>
    <script src="nr2.js"></script>
</head>
<body>
    <!-- Audio Start Overlay -->
    <div id="audio-start-overlay" class="audio-start-overlay">
        <div class="audio-start-content">
            <button id="audio-start-button" class="audio-start-button">
                <svg width="80" height="80" viewBox="0 0 80 80">
                    <polygon points="25,15 25,65 65,40" fill="white"/>
                </svg>
                <span>Click to Start</span>
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Full-band Spectrum Display -->
        <div class="spectrum-display-panel">
            <div class="spectrum-display-container">
                <canvas id="spectrum-line-graph-canvas" style="display: none;"></canvas>
                <canvas id="spectrum-display-canvas"></canvas>
                <!-- All controls overlay on bottom of spectrum -->
                <div class="spectrum-display-controls">
                    <div class="spectrum-control-group">
                        <button onclick="toggleSpectrumLineGraph()" id="spectrum-line-graph-toggle" title="Toggle Display Mode">Split</button>
                    </div>
                    <div class="spectrum-control-group">
                        <button onclick="spectrumResetZoom()" title="Reset Zoom">Reset</button>
                        <button onclick="spectrumZoomOut()" title="Zoom Out">‚àí</button>
                        <button onclick="spectrumZoomIn()" title="Zoom In">+</button>
                        <button onclick="spectrumMaxZoom()" title="Maximum Zoom">Max</button>
                        <span id="spectrum-zoom-level">1√ó</span>
                    </div>
                    <div class="spectrum-control-group">
                        <label>Colour Scheme:</label>
                        <select id="spectrum-colorscheme" onchange="updateSpectrumColorScheme()">
                            <option value="viridis">Viridis</option>
                            <option value="plasma">Plasma</option>
                            <option value="jet" selected>Jet</option>
                        </select>
                    </div>
                    <div class="spectrum-control-group">
                        <label for="spectrum-intensity">Intensity:</label>
                        <input type="range" id="spectrum-intensity" min="-1" max="1" value="0.30" step="0.05" oninput="updateSpectrumIntensity()">
                        <span id="spectrum-intensity-value">+0.30</span>
                    </div>
                    <div class="spectrum-control-group">
                        <label for="spectrum-contrast">Contrast:</label>
                        <input type="range" id="spectrum-contrast" min="0" max="100" value="70" step="5" oninput="updateSpectrumContrast()">
                        <span id="spectrum-contrast-value">70</span>
                    </div>
                    <div class="spectrum-control-group">
                        <label>Signal:</label>
                        <div class="signal-meter">
                            <div id="signal-meter-bar" class="signal-meter-bar"></div>
                        </div>
                        <span id="signal-meter-value">-- dB</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="frequency-input-wrapper">
                    <input type="number" id="frequency" value="14175000" min="100000" max="30000000" step="1000" oninput="validateFrequencyInput(this)" onchange="handleFrequencyChange()">
                    <span class="frequency-unit">Hz</span>
                </div>
                <div class="tuning-buttons">
                    <button onclick="adjustFrequency(-1000)" title="Down 1 kHz">‚óÑ‚óÑ</button>
                    <button onclick="adjustFrequency(-100)" title="Down 100 Hz">‚óÑ</button>
                    <button onclick="adjustFrequency(-10)" title="Down 10 Hz">‚óÇ</button>
                    <button onclick="adjustFrequency(10)" title="Up 10 Hz">‚ñ∏</button>
                    <button onclick="adjustFrequency(100)" title="Up 100 Hz">‚ñ∫</button>
                    <button onclick="adjustFrequency(1000)" title="Up 1 kHz">‚ñ∫‚ñ∫</button>
                </div>
                <div class="preset-buttons">
                    <button onclick="setBand('80m')" class="band-btn" data-band="80m">80m</button>
                    <button onclick="setBand('40m')" class="band-btn" data-band="40m">40m</button>
                    <button onclick="setBand('30m')" class="band-btn" data-band="30m">30m</button>
                    <button onclick="setBand('20m')" class="band-btn" data-band="20m">20m</button>
                    <button onclick="setBand('17m')" class="band-btn" data-band="17m">17m</button>
                    <button onclick="setBand('15m')" class="band-btn" data-band="15m">15m</button>
                    <button onclick="setBand('12m')" class="band-btn" data-band="12m">12m</button>
                    <button onclick="setBand('10m')" class="band-btn" data-band="10m">10m</button>
                </div>
            </div>

            <div class="control-group">
                <div class="preset-buttons">
                    <button onclick="setMode('usb')" id="mode-usb" class="mode-btn active">USB</button>
                    <button onclick="setMode('lsb')" id="mode-lsb" class="mode-btn">LSB</button>
                    <button onclick="setMode('cwu')" id="mode-cwu" class="mode-btn">CWU</button>
                    <button onclick="setMode('cwl')" id="mode-cwl" class="mode-btn">CWL</button>
                    <button onclick="setMode('am')" id="mode-am" class="mode-btn">AM</button>
                    <button onclick="setMode('sam')" id="mode-sam" class="mode-btn" disabled style="opacity: 0.5; cursor: not-allowed;" title="SAM mode temporarily disabled due to known issues">SAM</button>
                    <button onclick="setMode('fm')" id="mode-fm" class="mode-btn">FM</button>
                    <button onclick="setMode('nfm')" id="mode-nfm" class="mode-btn">NFM</button>
                </div>
                <div class="current-settings-text">
                    <span id="current-freq">-</span> ‚Ä¢ <span id="current-mode">-</span>
                </div>
                <div class="bandwidth-controls">
                    <div class="control-group">
                        <label for="bandwidth-low">Low: <span id="bandwidth-low-value">50</span> Hz</label>
                        <input type="range" id="bandwidth-low" min="-8000" max="500" value="50" step="10" oninput="updateBandwidthDisplay()" onchange="updateBandwidth()">
                    </div>
                    <div class="control-group">
                        <label for="bandwidth-high">High: <span id="bandwidth-high-value">3000</span> Hz</label>
                        <input type="range" id="bandwidth-high" min="500" max="6000" value="3000" step="100" oninput="updateBandwidthDisplay()" onchange="updateBandwidth()">
                    </div>
                </div>
            </div>

        </div>

        <div class="audio-controls">
            <div class="control-group">
                <label for="volume">Volume</label>
                <input type="range" id="volume" min="0" max="100" value="70">
                <span id="volume-value">70%</span>
            </div>
            <div class="control-group">
                <button id="mute-btn" onclick="toggleMute()">üîä Mute</button>
                <button id="nr2-quick-toggle" onclick="toggleNR2Quick()" style="background-color: #fd7e14; margin-left: 10px;">NR2</button>
                <button id="rec-btn" onclick="openRecorderModal()" style="margin-left: 10px;">‚è∫ Rec</button>
            </div>
            <div class="control-group vu-meter-compact-container" id="vu-meter-compact">
                <div class="vu-meter">
                    <div id="vu-meter-bar-compact" class="vu-meter-bar"></div>
                    <div id="vu-meter-peak-compact" class="vu-meter-peak"></div>
                    <div class="vu-meter-scale">
                        <span>-60</span>
                        <span>-40</span>
                        <span>-20</span>
                        <span>-10</span>
                        <span>-5</span>
                        <span>0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Visualization Section (Collapsible) -->
        <div class="audio-visualization-section">
            <div class="audio-visualization-header" onclick="toggleAudioVisualization()">
                <h3>Audio Visualisation</h3>
                <span id="audio-viz-toggle" class="toggle-icon">‚ñº</span>
            </div>
            <div id="audio-visualization-content" class="audio-visualization-content" style="display: block;">
                <div class="visualizer-panel">
                    <div class="top-visualizers">
                <div class="vu-meter-container">
                    <div class="vu-meter">
                        <div id="vu-meter-bar" class="vu-meter-bar"></div>
                        <div id="vu-meter-peak" class="vu-meter-peak"></div>
                        <div class="vu-meter-scale">
                            <span>-60</span>
                            <span>-40</span>
                            <span>-20</span>
                            <span>-10</span>
                            <span>-5</span>
                            <span>0</span>
                        </div>
                    </div>
                    <div class="vu-meter-values">
                        <div class="vu-value-item">
                            <span class="vu-label">RMS:</span>
                            <span id="vu-rms-value" class="vu-value">-‚àû dB</span>
                        </div>
                        <div class="vu-value-item">
                            <span class="vu-label">Peak:</span>
                            <span id="vu-peak-value" class="vu-value">-‚àû dB</span>
                        </div>
                    </div>
                </div>
                <div class="oscilloscope-container">
                    <canvas id="oscilloscope-canvas" width="400" height="140"></canvas>
                    <div class="oscilloscope-controls" style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="oscilloscope-zoom">Timebase:</label>
                            <input type="range" id="oscilloscope-zoom" min="1" max="200" value="200" step="1" oninput="updateOscilloscopeZoom()">
                            <span id="oscilloscope-zoom-value">-- ms</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button id="auto-sync-btn" onclick="autoSyncOscilloscope()" style="padding: 4px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Toggle trigger lock for stable waveform">Auto Sync</button>
                            <button id="auto-scale-btn" onclick="autoScaleOscilloscope()" style="padding: 4px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Toggle continuous auto-scaling of Y-axis">Auto Scale</button>
                            <button id="set-1khz-btn" onclick="shiftFrequencyTo1kHz()" style="padding: 4px 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;" title="Shift detected signal to 1 kHz">Set 1 kHz</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="spectrum-container">
                <canvas id="spectrum-canvas" width="2048" height="150"></canvas>
            </div>
            <div class="waterfall-container">
                <div style="position: relative;">
                    <canvas id="waterfall-canvas" width="2048" height="400"></canvas>
                    <canvas id="waterfall-overlay-canvas" width="2048" height="400" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                </div>
                <div class="waterfall-controls">
                    <div class="waterfall-control-group">
                        <label for="fft-size">FFT Size:</label>
                        <select id="fft-size" onchange="updateFFTSize()">
                            <option value="2048">2048 (Fastest)</option>
                            <option value="4096">4096 (Fast)</option>
                            <option value="8192">8192 (Balanced)</option>
                            <option value="16384" selected>16384 (High Detail)</option>
                            <option value="32768">32768 (Very High Detail)</option>
                            <option value="65536">65536 (Ultra Detail - CW)</option>
                        </select>
                    </div>
                    <div class="waterfall-control-group">
                        <label for="scroll-rate">Scroll Rate:</label>
                        <select id="scroll-rate" onchange="updateScrollRate()">
                            <option value="100">Slow (10 fps)</option>
                            <option value="50">Medium (20 fps)</option>
                            <option value="33" selected>Fast (30 fps)</option>
                            <option value="16">Very Fast (60 fps)</option>
                        </select>
                    </div>
                    <div class="waterfall-control-group">
                        <label for="waterfall-intensity">Intensity:</label>
                        <input type="range" id="waterfall-intensity" min="-1" max="1" value="0" step="0.05" oninput="updateWaterfallIntensity()">
                        <span id="waterfall-intensity-value">+0.00</span>
                    </div>
                    <div class="waterfall-control-group">
                        <label for="waterfall-contrast">Contrast:</label>
                        <input type="range" id="waterfall-contrast" min="0" max="100" value="50" step="5" oninput="updateWaterfallContrast()">
                        <span id="waterfall-contrast-value">50</span>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>

        <!-- CW Decoder (shown only in CWU/CWL modes) -->
        <div class="cw-decoder-panel" id="cw-decoder-panel" style="display: none;">
            <div class="cw-decoder-container">
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="cw-decoder-enable" onchange="toggleCWDecoder()">
                        Enable CW Decoder
                    </label>
                </div>
                <div id="cw-decoder-controls" style="display: none;">
                    <div class="control-group">
                        <label for="cw-frequency">CW Tone Frequency: <span id="cw-frequency-value">400</span> Hz</label>
                        <input type="range" id="cw-frequency" min="300" max="1500" value="400" step="10" oninput="updateCWDecoderFrequency()">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 10px 0;">
                        <button onclick="huntCWSignal()" class="cw-btn" style="width: auto; padding: 5px 15px;">Hunt</button>
                        <button onclick="shiftCWSignalTo700Hz()" class="cw-btn" style="width: auto; padding: 5px 15px; background-color: #17a2b8;">Shift to 500 Hz</button>
                        <span style="color: #888; font-size: 0.9em;">Find & shift signals</span>
                        <span style="margin-left: 10px;">WPM: <span id="cw-wpm-value">-- (auto)</span></span>
                        <button onclick="resetCWDecoderWPM()" class="cw-btn" style="width: auto; padding: 5px 15px;">Reset</button>
                        <span style="margin-left: 20px;">Threshold: <span id="cw-threshold-value">0.0005</span></span>
                        <input type="range" id="cw-threshold" min="0.0001" max="0.01" value="0.0005" step="0.0001" oninput="updateCWDecoderThreshold()" style="width: 150px;">
                    </div>
                    <div class="control-group" style="display: none;">
                        <label for="cw-threshold-hidden">Hidden</label>
                    </div>
                    
                    <div class="cw-decoder-display">
                        <div class="cw-status-bar">
                            <div class="cw-signal-indicator">
                                <label>Signal:</label>
                                <div class="cw-signal-meter">
                                    <div id="cw-signal-bar" class="cw-signal-bar"></div>
                                </div>
                                <span id="cw-signal-value">0%</span>
                            </div>
                            <div class="cw-current-symbol">
                                <label>Symbol:</label>
                                <span id="cw-current-symbol">‚Äî</span>
                            </div>
                        </div>
                        <div class="cw-decoded-text-container">
                            <label>Decoded Text:</label>
                            <div id="cw-decoded-text" class="cw-decoded-text"></div>
                        </div>
                        <div class="cw-decoder-buttons">
                            <button onclick="clearCWText()" class="cw-btn">Clear</button>
                            <button onclick="copyCWText()" class="cw-btn">Copy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters: 2x3 Grid for Notch, Bandpass, NR2, Squelch, Compressor, Stereo Virtualizer -->
        <div class="filters-grid filters-grid-2x3">
            <!-- Row 1, Column 1: Notch -->
            <div class="notch-panel">
                <div class="notch-container" style="position: relative;">
                    <span id="notch-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="notch-enable" onchange="toggleNotchFilter()">
                            Notch Filters <span id="notch-count" style="color: #888;">(0/5)</span>
                        </label>
                    </div>
                    <div id="notch-controls">
                        <div style="margin-bottom: 15px;">
                            <button onclick="addManualNotch()" class="notch-add-btn">+ Add Notch Filter</button>
                        </div>
                        <div id="notch-list">
                            <p style="color: #888; font-style: italic; margin: 10px 0;">No notch filters added yet</p>
                        </div>
                        <button onclick="clearAllNotches()" class="eq-reset-btn" style="margin-top: 10px;">Clear All Notches</button>
                    </div>
                </div>
            </div>

            <!-- Row 1, Column 2: Bandpass -->
            <div class="bandpass-panel">
                <div class="bandpass-container" style="position: relative;">
                    <span id="bandpass-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="bandpass-enable" onchange="toggleBandpassFilter()">
                            Bandpass Filter
                        </label>
                    </div>
                    <div id="bandpass-controls">
                        <div class="control-group">
                            <label for="bandpass-center">Center Frequency: <span id="bandpass-center-value">800 Hz</span></label>
                            <input type="range" id="bandpass-center" min="100" max="3000" value="800" step="10" oninput="updateBandpassFilter()">
                        </div>
                        <div class="control-group">
                            <label for="bandpass-width">Bandwidth: <span id="bandpass-width-value">200 Hz</span></label>
                            <input type="range" id="bandpass-width" min="20" max="1000" value="200" step="10" oninput="updateBandpassFilter()">
                        </div>
                        <div class="control-group">
                            <label for="bandpass-stages">Filter Stages: <span id="bandpass-stages-rolloff-value">4 (48 dB/oct)</span></label>
                            <input type="range" id="bandpass-stages" min="1" max="6" value="4" step="1" oninput="updateBandpassFilter()">
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="bandpass-auto-q" checked onchange="updateBandpassFilter()">
                                Auto Q Factor
                            </label>
                        </div>
                        <div class="control-group" id="bandpass-q-control" style="display: none;">
                            <label for="bandpass-q-multiplier">Q Multiplier: <span id="bandpass-q-multiplier-value">1.0x</span></label>
                            <input type="range" id="bandpass-q-multiplier" min="0.5" max="2.0" value="1.0" step="0.1" oninput="updateBandpassFilter()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 1, Column 3: Noise Reduction (NR2) -->
            <div class="noise-reduction-panel">
                <div class="noise-reduction-container" style="position: relative;">
                    <span id="noise-reduction-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <span id="noise-reduction-clip-indicator" style="display: none; position: absolute; bottom: 8px; right: 15px; color: #ff0000; font-weight: bold; padding: 4px 10px; background-color: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 4px; z-index: 100; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚ö† CLIPPING</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="noise-reduction-enable" onchange="toggleNoiseReduction()">
                            Noise Reduction (NR2)
                        </label>
                    </div>
                    <div id="noise-reduction-controls">
                        <div class="control-group">
                            <label for="noise-reduction-strength">Strength: <span id="noise-reduction-strength-value">40%</span></label>
                            <input type="range" id="noise-reduction-strength" min="0" max="100" value="40" step="5" oninput="updateNoiseReduction()">
                        </div>
                        <div class="control-group">
                            <label for="noise-reduction-floor">Spectral Floor: <span id="noise-reduction-floor-value">10%</span></label>
                            <input type="range" id="noise-reduction-floor" min="0" max="10" value="10" step="0.5" oninput="updateNoiseReduction()">
                        </div>
                        <div class="control-group">
                            <label for="noise-reduction-adapt-rate">Adaptation Rate: <span id="noise-reduction-adapt-rate-value">1.0%</span></label>
                            <input type="range" id="noise-reduction-adapt-rate" min="0.1" max="5.0" value="1.0" step="0.1" oninput="updateNoiseReduction()">
                        </div>
                        <div class="control-group">
                            <label for="noise-reduction-makeup-gain">Makeup Gain: <span id="noise-reduction-makeup-gain-value">-3 dB</span></label>
                            <input type="range" id="noise-reduction-makeup-gain" min="-12" max="12" value="-3" step="0.5" oninput="updateNoiseReduction()">
                        </div>
                        <p class="help-text" style="font-size: 11px; margin-top: 8px;">Auto-learns noise on startup and frequency changes. Continuously adapts to slow variations. Higher strength = more aggressive. Adaptation rate controls how quickly the filter tracks changing noise.</p>
                    </div>
                </div>
            </div>

            <!-- Row 2, Column 1: Squelch -->
            <div class="squelch-panel">
                <div class="squelch-container" style="position: relative;">
                    <span id="squelch-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="squelch-enable" onchange="toggleSquelch()">
                            Squelch (Audio Gate)
                        </label>
                    </div>
                    <div id="squelch-controls">
                        <div class="control-group">
                            <label for="squelch-threshold">Threshold: <span id="squelch-threshold-value">-35 dB</span></label>
                            <input type="range" id="squelch-threshold" min="-80" max="-10" value="-35" step="1" oninput="updateSquelch()">
                        </div>
                        <div class="control-group">
                            <label for="squelch-hysteresis">Hysteresis: <span id="squelch-hysteresis-value">3 dB</span></label>
                            <input type="range" id="squelch-hysteresis" min="1" max="10" value="3" step="0.5" oninput="updateSquelch()">
                        </div>
                        <div class="control-group">
                            <label for="squelch-attack">Attack (Open): <span id="squelch-attack-value">20 ms</span></label>
                            <input type="range" id="squelch-attack" min="5" max="200" value="20" step="5" oninput="updateSquelch()">
                        </div>
                        <div class="control-group">
                            <label for="squelch-release">Release (Close): <span id="squelch-release-value">500 ms</span></label>
                            <input type="range" id="squelch-release" min="10" max="1000" value="500" step="10" oninput="updateSquelch()">
                        </div>
                        <div class="squelch-status">
                            <label>Status:</label>
                            <span id="squelch-status" style="font-weight: bold; color: #28a745;">OPEN</span>
                            <span id="squelch-level" style="margin-left: 15px; color: #888;">Level: -- dB</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2, Column 2: Compressor -->
            <div class="compressor-panel">
                <div class="compressor-container" style="position: relative;">
                    <span id="compressor-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <span id="compressor-clip-indicator" style="display: none; position: absolute; bottom: 8px; right: 15px; color: #ff0000; font-weight: bold; padding: 4px 10px; background-color: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 4px; z-index: 100; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚ö† CLIPPING</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="compressor-enable" onchange="toggleCompressor()">
                            Audio Compressor (AGC)
                        </label>
                    </div>
                    <div id="compressor-controls">
                        <div class="control-group">
                            <label for="compressor-threshold">Threshold: <span id="compressor-threshold-value">-24 dB</span></label>
                            <input type="range" id="compressor-threshold" min="-100" max="0" value="-24" step="1" oninput="updateCompressor()">
                        </div>
                        <div class="control-group">
                            <label for="compressor-ratio">Ratio: <span id="compressor-ratio-value">12:1</span></label>
                            <input type="range" id="compressor-ratio" min="1" max="20" value="12" step="1" oninput="updateCompressor()">
                        </div>
                        <div class="control-group">
                            <label for="compressor-attack">Attack: <span id="compressor-attack-value">0.003 s</span></label>
                            <input type="range" id="compressor-attack" min="0" max="1" value="0.003" step="0.001" oninput="updateCompressor()">
                        </div>
                        <div class="control-group">
                            <label for="compressor-release">Release: <span id="compressor-release-value">0.25 s</span></label>
                            <input type="range" id="compressor-release" min="0" max="1" value="0.25" step="0.01" oninput="updateCompressor()">
                        </div>
                        <div class="control-group">
                            <label for="compressor-makeup-gain">Makeup Gain: <span id="compressor-makeup-gain-value">+0 dB</span></label>
                            <input type="range" id="compressor-makeup-gain" min="0" max="40" value="0" step="1" oninput="updateCompressor()">
                        </div>
                        <button onclick="resetCompressor()" class="eq-reset-btn">Reset Compressor</button>
                    </div>
                </div>
            </div>

            <!-- Row 2, Column 3: Stereo Virtualizer -->
            <div class="stereo-virtualizer-panel">
                <div class="stereo-virtualizer-container" style="position: relative;">
                    <span id="stereo-virtualizer-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                    <span id="stereo-virtualizer-clip-indicator" style="display: none; position: absolute; bottom: 8px; right: 15px; color: #ff0000; font-weight: bold; padding: 4px 10px; background-color: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 4px; z-index: 100; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚ö† CLIPPING</span>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="stereo-virtualizer-enable" onchange="toggleStereoVirtualizer()">
                            Stereo Virtualiser
                        </label>
                    </div>
                    <div id="stereo-virtualizer-controls">
                        <div class="control-group">
                            <label for="stereo-width">Width: <span id="stereo-width-value">50%</span></label>
                            <input type="range" id="stereo-width" min="0" max="100" value="50" step="5" oninput="updateStereoVirtualizer()">
                        </div>
                        <div class="control-group">
                            <label for="stereo-delay">Delay: <span id="stereo-delay-value">16 ms</span></label>
                            <input type="range" id="stereo-delay" min="5" max="30" value="16" step="1" oninput="updateStereoVirtualizer()">
                        </div>
                        <div class="control-group">
                            <label for="stereo-separation">Separation: <span id="stereo-separation-value">40%</span></label>
                            <input type="range" id="stereo-separation" min="0" max="100" value="40" step="5" oninput="updateStereoVirtualizer()">
                        </div>
                        <div class="control-group">
                            <label for="stereo-makeup-gain">Makeup Gain: <span id="stereo-makeup-gain-value">+0.0 dB</span></label>
                            <input type="range" id="stereo-makeup-gain" min="0" max="12" value="0" step="0.5" oninput="updateStereoVirtualizer()">
                        </div>
                        <p class="help-text" style="font-size: 11px; margin-top: 8px;">Creates a wider stereo image from mono audio. Width controls overall effect, Delay adds spatial depth, Separation controls channel independence.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- End 2x3 Filters Grid -->

        <!-- Equalizer: Full Width Below Grid -->
        <div class="equalizer-panel">
            <div class="equalizer-container" style="position: relative;">
                <span id="equalizer-status-badge" class="filter-status-badge filter-disabled">DISABLED</span>
                <span id="equalizer-clip-indicator" style="display: none; position: absolute; bottom: 8px; right: 15px; color: #ff0000; font-weight: bold; padding: 4px 10px; background-color: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 4px; z-index: 100; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚ö† CLIPPING</span>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="equalizer-enable" onchange="toggleEqualizer()">
                        12-Band Equalizer
                    </label>
                </div>
                <div id="equalizer-controls">
                    <div class="control-group">
                        <label for="equalizer-makeup-gain">Makeup Gain: <span id="equalizer-makeup-gain-value">+0 dB</span></label>
                        <input type="range" id="equalizer-makeup-gain" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    </div>
                    <div class="equalizer-bands">
                        <div class="eq-band">
                    <label class="eq-label">60 Hz</label>
                    <input type="range" class="eq-slider" id="eq-60" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-60-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">170 Hz</label>
                    <input type="range" class="eq-slider" id="eq-170" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-170-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">310 Hz</label>
                    <input type="range" class="eq-slider" id="eq-310" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-310-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">600 Hz</label>
                    <input type="range" class="eq-slider" id="eq-600" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-600-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">1 kHz</label>
                    <input type="range" class="eq-slider" id="eq-1000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-1000-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">1.5 kHz</label>
                    <input type="range" class="eq-slider" id="eq-1500" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-1500-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">2 kHz</label>
                    <input type="range" class="eq-slider" id="eq-2000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-2000-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">2.5 kHz</label>
                    <input type="range" class="eq-slider" id="eq-2500" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-2500-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">3 kHz</label>
                    <input type="range" class="eq-slider" id="eq-3000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-3000-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">4 kHz</label>
                    <input type="range" class="eq-slider" id="eq-4000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-4000-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">6 kHz</label>
                    <input type="range" class="eq-slider" id="eq-6000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-6000-value">0 dB</span>
                </div>
                <div class="eq-band">
                    <label class="eq-label">8 kHz</label>
                    <input type="range" class="eq-slider" id="eq-8000" min="-12" max="12" value="0" step="0.5" oninput="updateEqualizer()">
                    <span class="eq-value" id="eq-8000-value">0 dB</span>
                        </div>
                    </div>
                    <button onclick="resetEqualizer()" class="eq-reset-btn">Reset EQ</button>
                </div>
            </div>
            </div>
        </div>
        <!-- Active Channels Display -->
        <div class="active-channels-panel">
            <div class="active-channels-container">
                <h3>Active Channels</h3>
                <div id="active-channels-list" class="active-channels-list">
                    <p style="color: #888; font-style: italic;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- End Filters Grid -->

    </div>

    <!-- Audio Recorder Modal -->
    <div id="recorder-modal" class="modal" style="display: none;">
        <div class="modal-content recorder-modal-content">
            <div class="modal-header">
                <h2>Audio Recorder</h2>
                <button class="modal-close" onclick="closeRecorderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="recorder-status">
                    <div class="recorder-status-indicator" id="recorder-status-indicator"></div>
                    <span id="recorder-status-text">Stopped</span>
                </div>
                <div class="recorder-time">
                    <span id="recording-time">00:00</span>
                </div>
                <div class="recorder-controls">
                    <button id="recorder-start-btn" onclick="startRecording()" class="recorder-btn recorder-start-btn">
                        <span>‚è∫</span> Start Recording
                    </button>
                    <button id="recorder-stop-btn" onclick="stopRecording()" class="recorder-btn recorder-stop-btn" disabled>
                        <span>‚èπ</span> Stop Recording
                    </button>
                </div>
                <div class="recorder-actions">
                    <button id="recorder-download-btn" onclick="downloadRecording()" class="recorder-btn recorder-download-btn" disabled>
                        <span>‚¨á</span> Download Recording
                    </button>
                    <button id="recorder-clear-btn" onclick="clearRecording()" class="recorder-btn recorder-clear-btn" disabled>
                        <span>üóë</span> Clear Recording
                    </button>
                </div>
                <div class="recorder-info">
                    <p><strong>Note:</strong> Recording captures the processed audio output including all active filters and effects.</p>
                    <p>Recordings are saved in WebM format with Opus codec.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="spectrum-display.js"></script>
    <script src="cw-decoder.js"></script>
    <script src="recorder.js"></script>
    <script src="app.js"></script>
</body>
</html>